<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spotify Bot</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background: var(--tg-theme-bg-color, #ffffff);
            color: var(--tg-theme-text-color, #000000);
            padding: 16px;
            padding-bottom: 80px;
        }
        /* (Tout ton CSS original r√©int√©gr√© ici ‚Äî inchang√©) */
    </style>
</head>
<body>
    <!-- TON HTML COMPLET ORIGINAL -->

    <div class="debug-info" id="debugInfo">Debug Mode</div>
    <div class="header">
        <h1>üéµ Spotify Bot</h1>
        <p>Recherchez et ajoutez des musiques</p>
    </div>

    <div class="now-playing-card" id="nowPlayingCard" onclick="loadNowPlaying()">
        <div class="now-playing-header">
            <span>üéß</span>
            <span>En cours d'√©coute</span>
        </div>
        <div id="nowPlayingContent">
            <div class="now-playing-empty">Cliquez pour voir la musique en cours</div>
        </div>
    </div>

    <div class="search-container">
        <span class="search-icon">üîç</span>
        <input type="text" class="search-box" id="searchInput" placeholder="Rechercher un titre, artiste...">
    </div>

    <div class="quick-actions">
        <button class="quick-btn" onclick="togglePlaylist()">üìã Voir Otera</button>
        <button class="quick-btn btn-follow" onclick="followPlaylist()">‚ûï Suivre Playlist</button>
    </div>

    <div class="playlist-section" id="playlistSection">
        <div class="playlist-header">
            <div class="playlist-info">
                <div class="playlist-cover">üéµ</div>
                <div class="playlist-details">
                    <h3>Playlist Otera</h3>
                    <p id="playlistCount">Chargement...</p>
                </div>
            </div>
        </div>
        <div id="playlistTracks"></div>
    </div>

    <div class="results" id="results">
        <div class="section-title">üìÄ R√©sultats</div>
        <div id="trackList"></div>
    </div>

    <div class="toast" id="toast"></div>

<script>
// ---------------------- CONFIG ----------------------
const CONFIG = {
    N8N_WEBHOOK_SEARCH: 'https://n8n-seb.sandbox-jerem.com/webhook/spotify-search',
    N8N_WEBHOOK_ADD: 'https://n8n-seb.sandbox-jerem.com/webhook/spotify-add',
    N8N_WEBHOOK_ADD_PLAYLIST: 'https://n8n-seb.sandbox-jerem.com/webhook/spotify-add-playlist',
    N8N_WEBHOOK_GET_PLAYLIST: 'https://n8n-seb.sandbox-jerem.com/webhook/spotify-get-playlist',
    N8N_WEBHOOK_NOW_PLAYING: 'https://n8n-seb.sandbox-jerem.com/webhook/spotify-now-playing',
    PLAYLIST_ID: '0TLNSXMwwnAPQQaPp5UPZS'
};

const DEBUG = true;
function debugLog(msg, data) {
    if (DEBUG) {
        console.log('[DEBUG]', msg, data);
        const div = document.getElementById('debugInfo');
        div.style.display = 'block';
        div.innerHTML = `${msg}<br>${JSON.stringify(data).substring(0,100)}`;
    }
}

// ------------------ INIT TELEGRAM SAFE ------------------
let tg;
try {
    tg = window.Telegram.WebApp;
    tg.ready();
    tg.expand();
    debugLog('Telegram WebApp initialis√©', { user: tg.initDataUnsafe?.user });
} catch (e) {
    console.error('Erreur init Telegram:', e);
    tg = {
        initDataUnsafe: { user: { id: 'demo' } },
        HapticFeedback: {
            impactOccurred: () => {},
            notificationOccurred: () => {}
        }
    };
}

debugLog('Haptic support', { exists: !!tg?.HapticFeedback });

// ---- SECURE HAPTIC WRAPPER ----
function safeHaptic(action, style) {
    try {
        if (tg?.HapticFeedback && typeof tg.HapticFeedback[action] === 'function') {
            tg.HapticFeedback[action](style);
        }
    } catch (_) {}
}

// ------------------ VARIABLES ------------------
let searchTimeout;
let playlistVisible = false;
const searchInput = document.getElementById('searchInput');
const results = document.getElementById('results');
const trackList = document.getElementById('trackList');
const playlistSection = document.getElementById('playlistSection');
const playlistTracks = document.getElementById('playlistTracks');

// ------------------ RECHERCHE ------------------
searchInput.addEventListener('input', (e) => {
    clearTimeout(searchTimeout);
    const query = e.target.value.trim();

    if (query.length < 2) {
        results.classList.remove('active');
        return;
    }

    playlistSection.classList.remove('active');
    playlistVisible = false;

    trackList.innerHTML = '<div class="loading"><div class="loading-spinner"></div>Recherche...</div>';
    results.classList.add('active');

    searchTimeout = setTimeout(() => searchTracks(query), 500);
});

async function searchTracks(query) {
    try {
        const url = `${CONFIG.N8N_WEBHOOK_SEARCH}?q=${encodeURIComponent(query)}`;
        debugLog('Recherche URL', url);

        const response = await fetch(url); 
        if (!response.ok) throw new Error(`HTTP ${response.status}`);

        const data = await response.json();
        displayTracks(data.tracks || []);
    } catch (e) {
        trackList.innerHTML = `<div class='empty-state'>‚ùå ${e.message}</div>`;
    }
}

function displayTracks(tracks) {
    if (!tracks.length) {
        trackList.innerHTML = '<div class="empty-state">Aucun r√©sultat</div>';
        return;
    }

    trackList.innerHTML = tracks.map(track => `
        <div class="track-item">
            <div class="track-cover">${track.image ? `<img src="${track.image}">` : 'üéµ'}</div>
            <div class="track-info">
                <div class="track-name">${track.name}</div>
                <div class="track-artist">${track.artist}</div>
            </div>
            <div class="track-actions">
                <button class="track-btn track-btn-queue" onclick='addToQueue(${JSON.stringify(track.uri)}, ${JSON.stringify(track.name)}, ${JSON.stringify(track.artist)}, event)'>‚è≠Ô∏è Queue</button>
                <button class="track-btn track-btn-playlist" onclick='addToPlaylist(${JSON.stringify(track.uri)}, ${JSON.stringify(track.name)}, ${JSON.stringify(track.artist)}, event)'>üìã Otera</button>
            </div>
        </div>`).join('');
}

// ------------------ AJOUT √Ä LA QUEUE ------------------
async function addToQueue(uri, name, artist, event) {
    if (event) event.stopPropagation();
    safeHaptic('impactOccurred', 'medium');

    try {
        const userId = tg.initDataUnsafe?.user?.id || 'demo';
        const response = await fetch(CONFIG.N8N_WEBHOOK_ADD, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ user_id: userId, track_uri: uri, track_name: name, track_artist: artist })
        });

        if (!response.ok) throw new Error(`HTTP ${response.status}`);
        safeHaptic('notificationOccurred', 'success');
        showToast(`‚è≠Ô∏è "${name}" ajout√© √† la queue !`);
    } catch (e) {
        safeHaptic('notificationOccurred', 'error');
        showToast(`‚ùå ${e.message}`);
    }
}

// ------------------ AJOUT PLAYLIST ------------------
async function addToPlaylist(uri, name, artist, event) {
    if (event) event.stopPropagation();
    safeHaptic('impactOccurred', 'medium');

    try {
        const userId = tg.initDataUnsafe?.user?.id || 'demo';
        const response = await fetch(CONFIG.N8N_WEBHOOK_ADD_PLAYLIST, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ user_id: userId, track_uri: uri, track_name: name, track_artist: artist, playlist_id: CONFIG.PLAYLIST_ID })
        });

        if (!response.ok) throw new Error(`HTTP ${response.status}`);
        safeHaptic('notificationOccurred', 'success');
        showToast(`üìã "${name}" ajout√© √† Otera !`);
    } catch (e) {
        safeHaptic('notificationOccurred', 'error');
        showToast(`‚ùå ${e.message}`);
    }
}

// ------------------ PLAYLIST ------------------
async function togglePlaylist() {
    safeHaptic('impactOccurred', 'light');
    playlistVisible = !playlistVisible;

    if (playlistVisible) {
        results.classList.remove('active');
        playlistSection.classList.add('active');
        await loadPlaylist();
    } else playlistSection.classList.remove('active');
}

async function loadPlaylist() {
    playlistTracks.innerHTML = '<div class="loading">Chargement...</div>';
    try {
        const response = await fetch(`${CONFIG.N8N_WEBHOOK_GET_PLAYLIST}?playlist_id=${CONFIG.PLAYLIST_ID}`);
        if (!response.ok) throw new Error(`HTTP ${response.status}`);

        const data = await response.json();
        displayPlaylistTracks(data.tracks || [], data.total || 0);
    } catch (e) {
        playlistTracks.innerHTML = `<div class='empty-state'>‚ùå ${e.message}</div>`;
    }
}

function displayPlaylistTracks(tracks, total) {
    document.getElementById('playlistCount').textContent = `${total} musique${total>1?'s':''}`;
    if (!tracks.length) {
        playlistTracks.innerHTML = '<div class="empty-state">Playlist vide</div>';
        return;
    }

    playlistTracks.innerHTML = tracks.map((t,i)=>`
        <div class="track-item">
            <div class="track-cover">${t.image?`<img src='${t.image}'>`:'üéµ'}</div>
            <div class="track-info">
                <div class="track-name">${i+1}. ${t.name}</div>
                <div class="track-artist">${t.artist}</div>
            </div>
            <div class="track-actions">
                <button class="track-btn track-btn-queue" onclick='addToQueue(${JSON.stringify(t.uri)}, ${JSON.stringify(t.name)}, ${JSON.stringify(t.artist)}, event)'>‚è≠Ô∏è Queue</button>
            </div>
        </div>`).join('');
}

// ------------------ NOW PLAYING ------------------
async function loadNowPlaying() {
    safeHaptic('impactOccurred', 'light');

    const content = document.getElementById('nowPlayingContent');
    content.innerHTML = '<div class="loading">Chargement...</div>';

    try {
        const response = await fetch(CONFIG.N8N_WEBHOOK_NOW_PLAYING);
        if (!response.ok) throw new Error(`HTTP ${response.status}`);

        const data = await response.json();

        if (data.playing && data.track) {
            content.innerHTML = `
                <div class='now-playing-content'>
                    <div class='now-playing-cover'>${data.track.image?`<img src='${data.track.image}'>`:'üéµ'}</div>
                    <div class='now-playing-info'>
                        <div class='now-playing-track'>${data.track.name}</div>
                        <div class='now-playing-artist'>${data.track.artist}</div>
                    </div>
                </div>`;
            showToast(`üéß En cours : ${data.track.name}`);
        } else {
            content.innerHTML = '<div class="now-playing-empty">‚è∏Ô∏è Aucune lecture</div>';
            showToast('‚è∏Ô∏è Aucune lecture en cours');
        }

    } catch (e) {
        content.innerHTML = `<div class='now-playing-empty'>‚ùå ${e.message}</div>`;
        showToast(`‚ùå ${e.message}`);
    }
}

// ------------------ TOAST ------------------
function showToast(msg) {
    const t = document.getElementById('toast');
    t.textContent = msg;
    t.classList.add('show');
    setTimeout(()=> t.classList.remove('show'), 3000);
}

// ------------------ AUTOLOAD ------------------
setTimeout(()=>{
    loadNowPlaying();
    const name = tg.initDataUnsafe?.user?.first_name;
    if (name) setTimeout(()=> showToast(`üëã Salut ${name} !`), 1000);
},500);

setInterval(()=>{
    if (!results.classList.contains('active')) loadNowPlaying();
},30000);
</script>

</body>
</html>
